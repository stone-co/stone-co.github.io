<!doctype html><html lang=pt><head><meta charset=utf-8><title>Webhooks</title><meta name=generator content="Hugo 0.69.0"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=stylesheet href=https://stone-co.github.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://stone-co.github.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://stone-co.github.io/plugins/highlight/hybrid.css><link rel=icon href=https://stone-co.github.io/images/favicon.png type=image/x-icon><link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700&display=swap" rel=stylesheet><style>:root{--primary-color:#14aa4b;--body-color:#f8f9fd;--text-color:#677481;--text-color-dark:#5a6872;--white-color:#ffffff;--light-color:#f4f4f9;--font-family:Montserrat}</style><link href=https://stone-co.github.io/css/style.min.css rel=stylesheet media=screen><script src=https://stone-co.github.io/plugins/jquery/jquery-1.12.4.js></script><script src=https://stone-co.github.io/plugins/jquery/jquery-ui.js></script><script src=https://stone-co.github.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://stone-co.github.io/plugins/match-height/jquery.matchHeight-min.js></script><script src=https://stone-co.github.io/plugins/highlight/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></head><body><header class="shadow-bottom sticky-top bg-white"><nav class="navbar navbar-expand-md navbar-light"><div class=container><a class="navbar-brand px-2" href=/><img class=img-fluid src=https://stone-co.github.io/stoneg.png alt="Stone OpenBank"></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation aria-controls=navigation aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class="nav-link text-dark" href=/></a></li><li class=nav-item><a class="nav-link text-dark" href=/referencia-da-api>Referência da API</a></li><li class=nav-item><a class="nav-link text-dark" href=/guias>Guias</a></li><li class=nav-item><a class="nav-link text-dark" href=https://docs.openbank.stone.com.br/docs/overview-guides>Quero ser parceiro</a></li></ul></div></div></nav></header><section class="single section-sm pb-0"><div class=container><div class=row><div class=col-lg-3><div class="bg-white pl-lg-4 py-4 pr-4 mb-5 mb-lg-0 sticky-top top-100 overflow-hidden"><ul class=list-styled><a class="d-block h4 back-btn" href=/></a><li data-nav-id=https://stone-co.github.io/guias/ title=Guias class=sidelist><a href=https://stone-co.github.io/guias/>Guias</a><ul><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/ title="Stone Openbank API" class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/>Stone Openbank API</a><ul><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/overview/ title=Overview class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/overview/>Overview</a></li><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/quickstart/ title=Quickstart class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/quickstart/>Quickstart</a></li><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/ambientes-da-api/ title="Ambientes da API" class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/ambientes-da-api/>Ambientes da API</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/ title="A Conta Stone" class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/>A Conta Stone</a><ul><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/overview/ title=Overview class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/overview/>Overview</a></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/modelos-de-parceria/ title="Modelos De Parceria" class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/modelos-de-parceria/>Modelos De Parceria</a></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/aplicativos/ title=Aplicativos class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/aplicativos/>Aplicativos</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/integracao/ title=Integração class=sidelist><a href=https://stone-co.github.io/guias/integracao/>Integração</a><ul><li data-nav-id=https://stone-co.github.io/guias/integracao/boas-praticas/ title="Boas Práticas" class=sidelist><a href=https://stone-co.github.io/guias/integracao/boas-praticas/>Boas Práticas</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/cadastro-da-aplicacao/ title="Cadastro da Aplicação" class=sidelist><a href=https://stone-co.github.io/guias/integracao/cadastro-da-aplicacao/>Cadastro da Aplicação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/autenticacao/ title=Autenticação class=sidelist><a href=https://stone-co.github.io/guias/integracao/autenticacao/>Autenticação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/testando-a-api/ title="Testando a API" class=sidelist><a href=https://stone-co.github.io/guias/integracao/testando-a-api/>Testando a API</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/consentimento/ title=Consentimento class=sidelist><a href=https://stone-co.github.io/guias/integracao/consentimento/>Consentimento</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/aprovacao/ title=Aprovação class=sidelist><a href=https://stone-co.github.io/guias/integracao/aprovacao/>Aprovação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/webhooks/ title=Webhooks class="sidelist
active"><a href=https://stone-co.github.io/guias/integracao/webhooks/>Webhooks</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/tutoriais/ title=Tutoriais class=sidelist><a href=https://stone-co.github.io/guias/tutoriais/>Tutoriais</a><ul><li data-nav-id=https://stone-co.github.io/guias/tutoriais/integrando-na-pratica/ title="Integrando na Prática" class=sidelist><a href=https://stone-co.github.io/guias/tutoriais/integrando-na-pratica/>Integrando na Prática</a></li></ul></li></ul></li></ul></div></div><div class=col-lg-9><div class="p-lg-5 p-4 bg-white"><h2 class=mb-5>Webhooks</h2><div class=content><p>A ocorrência de certos eventos pode ser importante para iniciar um processamento na plataforma do parceiro. Por isso, utilizamos webhooks para notificá-lo da ocorrência destes eventos.</p><p>Para sua utilização, é preciso que sua aplicação tenha cadastrada no formulário a URI para a qual enviaremos um POST com os dados do evento. O parceiro deverá se preparar para lidar com cada evento de forma adequada.</p><p>Realizamos 50 tentativas de envio dos webhooks.</p><h4 id=os-eventos-que-geram-notificações-são>Os eventos que geram notificações são:</h4><table><thead><tr><th>Tipo de evento</th><th>Descrição</th></tr></thead><tbody><tr><td>barcode_payment_invoice_created</td><td>Representa a criação/emissão de um boleto.</td></tr><tr><td>barcode_payment_invoice_registered</td><td>Representa o registro de um boleto.</td></tr><tr><td>barcode_payment_invoice_payment_promissed</td><td>Representa que o pagamento do boleto foi acolhido em alguma instituição.</td></tr><tr><td>barcode_payment_invoice_settled</td><td>Representa a entrada do valor do boleto na conta do beneficiário.</td></tr><tr><td>cash_in_barcode_payment</td><td>Representa o recebimento do pagamento de um boleto.</td></tr><tr><td>cash_in_card_payment</td><td>Representa o recebimento de pagamentos de cartão de crédito, cartão de débito ou de antecipação de pagamentos.</td></tr><tr><td>cash_in_payment_refund</td><td>Representa o reembolso de um pagamento mal sucedido.</td></tr><tr><td>cash_in_internal_transfer</td><td>Representa o recebimento de uma transferência interna.</td></tr><tr><td>cash_in_external_transfer</td><td>Representa o recebimento de uma transferência externa.</td></tr><tr><td>cash_in_external_transfer_refund</td><td>Representa o reembolso de uma transferência externa mal sucedida.</td></tr><tr><td>cash_out_internal_transfer</td><td>Representa a criação de uma transferência interna.</td></tr><tr><td>cash_out_internal_transfer_failed</td><td>Representa a falha na criação de uma transferência interna.</td></tr><tr><td>cash_out_internal_transfer_scheduled</td><td>Representa o agendamento de uma transferência interna.</td></tr><tr><td>cash_out_internal_transfer_scheduled_failed</td><td>Representa a falha no agendamento de uma transferência interna.</td></tr><tr><td>cash_out_internal_transfer_approved</td><td>Representa a aprovação de uma transferência interna.</td></tr><tr><td>cash_out_internal_transfer_cancelled</td><td>Representa o cancelamento de uma transferência interna.</td></tr><tr><td>cash_out_internal_transfer_rejected</td><td>Representa a rejeição de uma transferência interna.</td></tr><tr><td>cash_out_internal_transfer_finished</td><td>Representa a finalização de uma transferência interna.</td></tr><tr><td>cash_out_internal_transfer_expired</td><td>Representa a expiração de uma transferência interna.</td></tr><tr><td>cash_out_external_transfer</td><td>Representa a criação de uma transferência externa.</td></tr><tr><td>cash_out_external_transfer_failed</td><td>Representa a falha na criação de uma transferência externa.</td></tr><tr><td>cash_out_external_transfer_scheduled</td><td>Representa o agendamento de uma transferência <em>externa</em>.</td></tr><tr><td>cash_out_external_transfer_scheduled_failed</td><td>Representa a falha no agendamento de uma transferência externa.</td></tr><tr><td>cash_out_external_transfer_approved</td><td>Representa a aprovação de uma transferência externa.</td></tr><tr><td>cash_out_external_transfer_cancelled</td><td>Representa o cancelamento de uma transferência externa.</td></tr><tr><td>cash_out_external_transfer_rejected</td><td>Representa a rejeição de uma transferência externa.</td></tr><tr><td>cash_out_external_transfer_finished</td><td>Representa a finalização de uma transferência externa.</td></tr><tr><td>cash_out_external_transfer_expired</td><td>Representa a expiração de uma transferência externa.</td></tr><tr><td>cash_out_external_transfer_execution_started</td><td>Representa o início da execução de uma transferência externa.</td></tr><tr><td>cash_out_payment</td><td>Representa a criação de um pagamento.</td></tr><tr><td>cash_out_payment_failed</td><td>Representa a falha na criação de um pagamento.</td></tr><tr><td>cash_out_payment_scheduled</td><td>Representa o agendamento de um pagamento.</td></tr><tr><td>cash_out_payment_scheduled_failed</td><td>Representa a falha no agendamento de um pagamento.</td></tr><tr><td>cash_out_payment_approved</td><td>Representa a aprovação de um pagamento.</td></tr><tr><td>cash_out_payment_cancelled</td><td>Representa o cancelamento de um pagamento.</td></tr><tr><td>cash_out_payment_rejected</td><td>Representa a rejeição de um pagamento.</td></tr><tr><td>cash_out_payment_finished</td><td>Representa a finalização de um pagamento.</td></tr><tr><td>cash_out_payment_expired</td><td>Representa a expiração de um pagamento.</td></tr><tr><td>cash_out_payment_execution_started</td><td>Representa o início da execução de um pagamento.</td></tr><tr><td>consent_requested</td><td>Representa a confirmação do pedido de consentimento por parte do user.</td></tr></tbody></table><h4 id=o-header-das-notificações-segue-a-seguinte-estrutura>O header das notificações segue a seguinte estrutura:</h4><pre><code class=language-json5 data-lang=json5>x-stone-webhook-event-id: &quot;930bbd6d-0c7a-4fe4-8b50-4b82a20cb847&quot;
x-stone-webhook-event-type: &quot;cash_out_internal_transfer&quot;
</code></pre><h4 id=o-payload-da-notificações-segue-a-seguinte-estrutura>O payload da notificações segue a seguinte estrutura:</h4><table><thead><tr><th>Campo</th><th>Descrição</th></tr></thead><tbody><tr><td>env</td><td>Especifica de qual ambiente partiu o evento. Valores possíveis: <code>sandbox</code> ou <code>production</code>.</td></tr><tr><td>event_type</td><td>Especifica qual tipo de evento disparou a notificação. Veja os valores possíveis <a href=https://docs.openbank.stone.com.br/docs/webhooks-guides#section-os-eventos-que-geram-notificacoes-sao>aqui</a>.</td></tr><tr><td>id</td><td>É o identificador da notificação.</td></tr><tr><td>event_notified_at</td><td>É a hora em que a notificação está sendo enviada.</td></tr><tr><td>event_happened_at</td><td>É a hora em que o evento ocorreu.</td></tr><tr><td>target_data</td><td>Objeto com as informações detalhadas do recurso que gerou o evento. Apesar de ter campo variáveis sempre conterá o campo <code>account_id</code>.</td></tr><tr><td>target_detail_uri</td><td>É o endereço onde se pode consultar os detalhes do recurso.</td></tr><tr><td>target_id</td><td>É o identificador do recurso que gerou o evento.</td></tr><tr><td>target_statement_uri</td><td>É o endereço da entrada no extrato referente ao recurso.</td></tr><tr><td>target_type</td><td>É o tipo do recurso.</td></tr></tbody></table><div class="notices info"><p><strong>Inclusão de campos</strong><br>A implementação não deve ser strict no parser do payload. Ao longo do tempo os payloads podem sofrer a inclusão de campos.</p></div><h5 id=exemplo>Exemplo:</h5><pre><code class=language-json5 data-lang=json5>{
   &quot;env&quot;:&quot;sandbox&quot;,
   &quot;event_type&quot;:&quot;cash_in_internal_transfer&quot;,
   &quot;event_happened_at&quot;:&quot;2020-05-13T14:58:15Z&quot;,
   &quot;event_notified_at&quot;:&quot;2020-05-13T14:58:15Z&quot;,
   &quot;iat&quot;:1589381895,
   &quot;id&quot;:null,
   &quot;jti&quot;:&quot;2o79sqemde14mv76eo00jsc3&quot;,
   &quot;nbf&quot;:1589381895,
   &quot;target_data&quot;:{
      &quot;account_id&quot;:&quot;09c016b2-876a-450a-9f40-316f8e2f8778&quot;,
      &quot;amount&quot;:1,
      &quot;balance_after&quot;:null,
      &quot;balance_before&quot;:null,
      &quot;counter_party&quot;:{
         &quot;account&quot;:{
            &quot;account_code&quot;:&quot;841412&quot;,
            &quot;branch_code&quot;:&quot;1&quot;,
            &quot;institution&quot;:&quot;16501555&quot;,
            &quot;institution_name&quot;:&quot;Stone Pagamentos S.A.&quot;
         },
         &quot;entity&quot;:{
            &quot;name&quot;:&quot;Loja Da Maria&quot;
         }
      },
      &quot;created_at&quot;:&quot;2020-05-13T14:58:15Z&quot;,
      &quot;description&quot;:&quot;&quot;,
      &quot;id&quot;:&quot;54abd61c-3b18-401c-9816-951cbe135149&quot;,
      &quot;operation&quot;:&quot;credit&quot;,
      &quot;status&quot;:&quot;FINISHED&quot;,
      &quot;type&quot;:&quot;internal&quot;
   },
   &quot;target_detail_uri&quot;:null,
   &quot;target_id&quot;:null,
   &quot;target_statement_uri&quot;:&quot;https://sandbox-api.openbank.stone.com.br/api/v1/statement/entries/54abd61c-3b18-401c-9816-951cbe135149&quot;,
   &quot;target_type&quot;:&quot;internal_transfer&quot;
}
</code></pre><h4 id=trabalhando-com-webhooks>Trabalhando com Webhooks</h4><h5 id=webhooks-seguros>Webhooks Seguros</h5><p>Nossa API envia webhooks de forma segura para evitar que eles sejam abertos e/ou alterados. Isso é feito em duas etapas:</p><ol><li>Assinatura do conteúdo usando uma das nossas <a href=https://api.openbank.stone.com.br/api/v1/discovery/keys>chaves públicas</a>.</li><li>Ciframento do resultado usando a chave pública do destinatário.</li></ol><h5 id=como-eu-posso-abrir-de-forma-segura-o-conteúdo-de-um-webhook>Como eu posso abrir de forma segura o conteúdo de um webhook?</h5><p>Para poder visualizar o conteúdo de um webhook é necessário fazer o caminho inverso:</p><ol><li>Usar sua chave privada para poder decifrar o conteúdo. O resultado é um token JWT assinado com a nossa chave;</li><li>Verificar a assinatura do token com a nossa chave pública.</li></ol><h5 id=1---decifrando-o-conteúdo-do-webhook>1 - Decifrando o conteúdo do webhook</h5><p>O webhook irá chegar com um payload parecido com esse:</p><pre><code class=language-json5 data-lang=json5>{
  &quot;encrypted_body&quot;: &quot;xxxxxxxxxxxxxx conteúdo cifrado&quot;
}

</code></pre><p>O valor do campo &ldquo;encrypted_body&rdquo; é um token no formato JWE (JSON Web Encryption) compacto. Esse formato é um padrão e várias linguagens possuem bibliotecas prontas para ele.</p><p>O algoritmo utilizado é: <strong>RSA-OAEP-256</strong> com <strong>A256GCM</strong>. Para decifrar o conteúdo é necessário uma biblioteca que suporte estes algoritmos como:</p><ul><li><a href=https://github.com/square/js-jose>JavaScript</a></li><li><a href=https://bitbucket.org/b_c/jose4j/wiki/Home>Java</a></li><li><a href=https://hexdocs.pm/jose/JOSE.html>Erlang/Elixir</a></li><li><a href=https://github.com/square/go-jose>Go</a></li></ul><p>A chave a ser utilizada tem que ser a <strong>chave privada</strong> par da <strong>chave pública</strong> usada na autenticação da aplicação.</p><h5 id=2---verificando-a-assinatura-do-conteúdo-do-webhook>2 - Verificando a assinatura do conteúdo do webhook</h5><p>Até este momento deciframos apenas um conteúdo que pode ser gerado por qualquer um que tenha acesso a chave pública da aplicação.</p><p>Nós utilizamos a assinatura do conteúdo em token JWS (JSON Web Signing) compacto como uma outra camada de verificação de segurança no conteúdo do webhook.</p><p>Esse token possui em seus &ldquo;claims&rdquo; (alegações) o conteúdo do webhook. Para garantir que ele foi gerado pela Stone, você deve validar a assinatura dele consultando nossas chaves públicas de assinatura.</p><p>As chaves públicas da Stone estão publicadas <a href=https://sandbox-api.openbank.stone.com.br/api/v1/discovery/keys>aqui</a>.</p><p>Repare que cada chave possui um <em>kid</em> (key ID) e um <em>use</em> (sig ou enc). O token JWS possui um header que diz qual é o id da chave usada para assiná-lo. Assim, é necessário, em primeiro lugar, garantir que o token foi assinado com uma chave que está publicada pela Stone.</p><p>O algoritmo que usamos será <em>sempre RS256</em>. Há uma lista de bibliotecas que tratam de assinatura de token em <a href=https://jwt.io/>jwt.io</a>.</p><h4 id=segurança>Segurança</h4><p>É importante seguir os dois passos aqui: tanto decifrar quanto verificar a assinatura. Isso irá garantir que não apenas geramos algo que não pode ser lido por alguém que <em>não possui</em> a chave pública quanto que nosso conteúdo foi assinado pela Stone.</p><p>Também aconselhamos cuidado na configuração do cliente que irá consultar as nossas chaves. Certifique-se que ele não está vulnerável a servidores intermediários propositalmente mal configurados. Um exemplo comum é um servidor configurado para protocolos conhecidamente falhos.</p><p>Sempre que em dúvida, consulte nossa API com os IDs dos dados no conteúdo do webhook.</p><p>Mais informações sobre JavaScript Object Signing and Encryption, como JWTs, JWEs, JWSs, <a href=https://www.ca.com/pt/blog-latam/os-beneficios-de-jwtjwsjwe-no-designs-de-apis.html>aqui</a>.</p></div><p class="post-meta border-bottom pb-3 mb-0 mt-3">Updated on 14 May 2020</p><nav class="pagination mt-3"><a class="nav nav-prev" href=https://stone-co.github.io/guias/integracao/aprovacao/><i class="ti-arrow-left mr-2"></i><span class="d-none d-md-block">Aprovação</span></a>
<a class="nav nav-next" href=https://stone-co.github.io/guias/tutoriais/><span class="d-none d-md-block">Tutoriais</span><i class="ti-arrow-right ml-2"></i></a></nav></div></div></div></div></section><footer class="section pb-4"><div class=container><div class="row align-items-center"><div class="col-md-8 text-md-left text-center"><p class="mb-md-0 mb-4"></p></div><div class="col-md-4 text-md-right text-center"><ul class=list-inline><li class=list-inline-item><a class="text-color d-inline-block p-2" href=#><i class=ti-world></i></a></li><li class=list-inline-item><a class="text-color d-inline-block p-2" href=#><i class=ti-github></i></a></li></ul></div></div></div></footer><script src=https://stone-co.github.io/js/script.min.js></script></body></html>