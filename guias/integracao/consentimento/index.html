<!doctype html><html lang=pt><head><meta charset=utf-8><title>Consentimento</title><meta name=generator content="Hugo 0.69.0"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=stylesheet href=https://stone-co.github.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://stone-co.github.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://stone-co.github.io/plugins/highlight/hybrid.css><link rel=icon href=https://stone-co.github.io/images/favicon.png type=image/x-icon><link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700&display=swap" rel=stylesheet><style>:root{--primary-color:#14aa4b;--body-color:#f8f9fd;--text-color:#677481;--text-color-dark:#5a6872;--white-color:#ffffff;--light-color:#f4f4f9;--font-family:Montserrat}</style><link href=https://stone-co.github.io/css/style.min.css rel=stylesheet media=screen><script src=https://stone-co.github.io/plugins/jquery/jquery-1.12.4.js></script><script src=https://stone-co.github.io/plugins/jquery/jquery-ui.js></script><script src=https://stone-co.github.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://stone-co.github.io/plugins/match-height/jquery.matchHeight-min.js></script><script src=https://stone-co.github.io/plugins/highlight/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></head><body><header class="shadow-bottom sticky-top bg-white"><nav class="navbar navbar-expand-md navbar-light"><div class=container><a class="navbar-brand px-2" href=/><img class=img-fluid src=https://stone-co.github.io/stoneg.png alt="Stone OpenBank"></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation aria-controls=navigation aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class="nav-link text-dark" href=/></a></li><li class=nav-item><a class="nav-link text-dark" href=https://docs.openbank.stone.com.br/reference>Referência da API</a></li><li class=nav-item><a class="nav-link text-dark" href=/guias>Guias</a></li><li class=nav-item><a class="nav-link text-dark" href="https://app.pipefy.com/public/form/Qz4ptt_W?origem_do_lead=Formul%C3%A1rio%20comercial%20documenta%C3%A7%C3%A3o">Quero ser parceiro</a></li></ul></div></div></nav></header><section class="single section-sm pb-0"><div class=container><div class=row><div class=col-lg-3><div class="bg-white pl-lg-4 py-4 pr-4 mb-5 mb-lg-0 sticky-top top-100 overflow-hidden"><ul class=list-styled><a class="d-block h4 back-btn" href=/></a><li data-nav-id=https://stone-co.github.io/guias/ title=Guias class=sidelist><a href=https://stone-co.github.io/guias/>Guias</a><ul><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/ title="Stone Openbank API" class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/>Stone Openbank API</a><ul><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/overview/ title=Overview class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/overview/>Overview</a></li><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/quickstart/ title=Quickstart class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/quickstart/>Quickstart</a></li><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/ambientes-da-api/ title="Ambientes da API" class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/ambientes-da-api/>Ambientes da API</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/ title="A Conta Stone" class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/>A Conta Stone</a><ul><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/overview/ title=Overview class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/overview/>Overview</a></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/modelos-de-parceria/ title="Modelos De Parceria" class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/modelos-de-parceria/>Modelos De Parceria</a></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/aplicativos/ title=Aplicativos class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/aplicativos/>Aplicativos</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/integracao/ title=Integração class=sidelist><a href=https://stone-co.github.io/guias/integracao/>Integração</a><ul><li data-nav-id=https://stone-co.github.io/guias/integracao/boas-praticas/ title="Boas Práticas" class=sidelist><a href=https://stone-co.github.io/guias/integracao/boas-praticas/>Boas Práticas</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/cadastro-da-aplicacao/ title="Cadastro da Aplicação" class=sidelist><a href=https://stone-co.github.io/guias/integracao/cadastro-da-aplicacao/>Cadastro da Aplicação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/autenticacao/ title=Autenticação class=sidelist><a href=https://stone-co.github.io/guias/integracao/autenticacao/>Autenticação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/testando-a-api/ title="Testando a API" class=sidelist><a href=https://stone-co.github.io/guias/integracao/testando-a-api/>Testando a API</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/consentimento/ title=Consentimento class="sidelist
active"><a href=https://stone-co.github.io/guias/integracao/consentimento/>Consentimento</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/aprovacao/ title=Aprovação class=sidelist><a href=https://stone-co.github.io/guias/integracao/aprovacao/>Aprovação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/webhooks/ title=Webhooks class=sidelist><a href=https://stone-co.github.io/guias/integracao/webhooks/>Webhooks</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/tutoriais/ title=Tutoriais class=sidelist><a href=https://stone-co.github.io/guias/tutoriais/>Tutoriais</a><ul><li data-nav-id=https://stone-co.github.io/guias/tutoriais/integrando-na-pratica/ title="Integrando na Prática" class=sidelist><a href=https://stone-co.github.io/guias/tutoriais/integrando-na-pratica/>Integrando na Prática</a></li></ul></li></ul></li></ul></div></div><div class=col-lg-9><div class="p-lg-5 p-4 bg-white"><h2 class=mb-5>Consentimento</h2><div class=content><h6 id=como-obter-acesso-às-contas-de-pagamento>Como obter acesso às contas de pagamento.</h6><hr><p>Consentimento é o processo em que a usuária dona da conta acessa um link gerado pela Aplicação Parceira e através dele permite o acesso a suas informações e a sua conta de pagamento.</p><p>Toda vez que uma Aplicação faz um pedido de consentimento a uma usuária o mesmo englobará todos os escopos que aquela aplicação tem. No fluxo serão listados para a usuária todos os escopos que estão sendo solicitados.</p><h4 id=fluxo-de-consentimento>Fluxo de consentimento</h4><p>Para realizar esse processo, a usuária precisa receber do sistema do parceiro um link que a direcione para uma página da Stone. Nessa página a usuária poderá escolher a quais contas de pagamento ela deseja conceder o acesso. Será necessário que o sistema do parceiro gere esse link, como descrito abaixo. O tempo de expiração do link deve ser de no máximo duas horas.</p><p>Caso a usuária <strong>não acesse o link</strong> disponibilizado dentro de seu intervalo de tempo de vida, ele irá expirar. Nesse caso não haverá a concessão do acesso e não será mais possível obtê-la através desse mesmo link, precisando gerar um novo.</p><p>Também é possível que a usuária acesse o link mas <strong>não conceda o acesso</strong>, ao escolher a opção <em>Ignorar</em>. Nesse caso a usuária será redirecionada para uma página do sistema do parceiro e não será possível para ele operar na conta da usuária.</p><p>Havendo a <strong>concessão de acesso</strong>, a usuária será redirecionada para uma página da Aplicação e o parceiro obterá as autorizações necessárias para operar na conta.</p><p>O sistema do parceiro será informado do ocorrido para cada um desses três casos.</p><p>Observe que no fluxo atual é preciso que o parceiro direcione sua cliente a abrir uma Conta Stone. Quando a usuária estiver com sua Conta Stone aberta, o parceiro poderá realizar o processo de consentimento para operar em sua conta.</p><h4 id=gerando-um-link-de-consentimento>Gerando um link de consentimento</h4><p>Uma vez cadastrada e autenticada a Aplicação, a primeira funcionalidade a ser desenvolvida é o consentimento.</p><p>Para dar início ao processo de consentimento, basta que a desenvolvedora gere um link com os parâmetros necessários conforme especificados abaixo. Toda a interação com a usuária será gerida pela nossa plataforma.</p><p>Após o link ser gerado, ele deverá ser enviado pela Aplicação Parceira para a usuária. Isso pode ser feito por e-mail ou dentro da própria Aplicação como, por exemplo, através de um botão.</p><h4 id=o-link-de-consentimento-deve-conter-três-parâmetros>O link de consentimento deve conter três parâmetros:</h4><ol><li><code>client_id</code>: o ClientID recebido pela desenvolvedora pós-cadastro;</li><li><code>type</code>: no caso, será sempre o valor &ldquo;consent&rdquo;;</li><li><code>jwt</code>: será um token gerado localmente pela desenvolvedora com a mesma chave privada e algoritmo que ela usa para se autenticar. Mais detalhes abaixo.</li></ol><p>Com estes parâmetros, basta gerar um link no seguinte formato (por ambiente):</p><ul><li><em>Sandbox</em>: <a href="https://sandbox-accounts.openbank.stone.com.br/#/consent?type=consent&amp;amp;client_id=CLIENT_ID&amp;amp;jwt=JWT">https://sandbox-accounts.openbank.stone.com.br/#/consent?type=consent&amp;amp;client_id=CLIENT_ID&amp;amp;jwt=JWT</a></li><li><em>Produção</em>: <a href="https://accounts.openbank.stone.com.br/#/consent?type=consent&amp;amp;client_id=CLIENT_ID&amp;amp;jwt=JWT">https://accounts.openbank.stone.com.br/#/consent?type=consent&amp;amp;client_id=CLIENT_ID&amp;amp;jwt=JWT</a></li></ul><p>Substituindo CLIENT_ID e JWT por seus respectivos valores.</p><h4 id=gerando-o-token>Gerando o token</h4><p>Gerar um token JWT de consentimento é parecido com o processo de gerar um token de autenticação. O token deve conter os <strong>claims</strong>:</p><table><thead><tr><th>Campo</th><th>Descrição</th><th>Tipo</th></tr></thead><tbody><tr><td><strong>Obrigatórios</strong></td><td></td><td></td></tr><tr><td>type</td><td>Será sempre &ldquo;consent&rdquo; neste caso.</td><td>String</td></tr><tr><td>client_id</td><td>Será o ClientID da Aplicação Parceira.</td><td>String</td></tr><tr><td>redirect_uri</td><td>A URI para redirecionamento após a ação da usuária. <strong>Esta URI foi informada previamente no cadastro da Aplicação Parceira. Caso seja enviada uma URI diferente, retornará erro.</strong></td><td>String</td></tr><tr><td>session_metadata</td><td>Um objeto que contenha qualquer chave relevante para o parceiro identificar a sessão da usuária. Este valor estará presente na URI de redirecionamento e não pode ser nulo ou um mapa vazio.</td><td>Objeto</td></tr><tr><td>iss</td><td>Usar o client_id da Aplicação.</td><td>String</td></tr><tr><td>iat</td><td>Momento em que o token foi gerado. É um timestamp UTC. Exemplo: <code>"iat": 1542235633</code>.</td><td>Int</td></tr><tr><td>aud</td><td><a href=mailto:accounts-hubid@openbank.stone.com.br>accounts-hubid@openbank.stone.com.br</a></td><td>String</td></tr><tr><td>jti</td><td>Identificador único do token gerado. Normalmente se utiliza um UUID.</td><td>String</td></tr><tr><td>nbf</td><td>É o momento em que o token passa a ser válido. Na maioria dos casos terá o mesmo valor que <code>iat</code> (issued at) pois queremos que ele esteja válido logo a partir do momento de geração.</td><td>Int</td></tr><tr><td>exp</td><td>Momento de expiração do token em segundos desde o início da era UNIX (1970). É um timestamp UTC e não pode ser maior que 2 horas. Exemplo: <code>\"exp\": 1542235633</code></td><td>Int</td></tr></tbody></table><p>Observe que é preciso <strong>assinar o token JWT com a chave privada da aplicação e o algoritmo RS256</strong>, assim como é feito para o token de <a href=https://docs.openbank.stone.com.br/docs/autenticacao-guides>autenticação</a>. Dessa forma, neste token também é preciso incluir um header com as informações sobre o algoritmo de criptografia utilizado, entre outros metadados, como um id da chave utilizada. Por exemplo:</p><pre><code class=language-json5 data-lang=json5>{
  &quot;alg&quot;: &quot;RS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}
</code></pre><div class="notices info"><p>Apesar do ClientID ser o disponibilizado pela Stone ao parceiro no <a href=https://docs.openbank.stone.com.br/docs/cadastro-da-aplicacao-guides>Cadastro da Aplicação</a> e o mesmo utilizado para montar o token de <a href=https://docs.openbank.stone.com.br/docs/autenticacao-guides#section-1-gerando-o-token-jwt>autenticação</a>, observe que o <strong>nome do campo</strong> para esse token é <code>client_id</code>, diferente de <code>clientId</code> utilizado no token de autenticação.</p></div><p>Assim, um exemplo de claims para este token seria:</p><pre><code class=language-json5 data-lang=json5>{
  &quot;type&quot;: &quot;consent&quot;,
  &quot;client_id&quot;: &quot;MY CLIENT ID&quot;, 
  &quot;iss&quot;: &quot;MY CLIENT ID&quot;,
  &quot;redirect_uri&quot;: &quot;https://mypreviouslyregistereduri.com&quot;,
  &quot;session_metadata&quot;: {
    &quot;user_session&quot;: &quot;xxxxxxxxxxxxxxxxxxxxx&quot;,
  },
  &quot;iat&quot;: 1542235633,
  &quot;nbf&quot;: 1542235633,
  &quot;exp&quot;: 1549069563,
    &quot;jti&quot;: &quot;41e8aa9f-bb9c-4fd2-9953-2595dbbd5a83&quot;,
  &quot;aud&quot;: &quot;accounts-hubid@openbank.stone.com.br&quot;
}
</code></pre><h4 id=redirect-callback>Redirect callback</h4><p>A usuária irá visualizar as permissões às quais a Aplicação Parceira está pedindo acesso e poderá optar por ignorar ou consentir o acesso.</p><p>Em ambos os casos, faremos um redirecionamento para a URI cadastrada no token. Acrescentaremos na URI os seguintes campos:</p><ul><li>os valores de session_metadata passados no token;</li><li>a chave &ldquo;consent_result&rdquo; que poderá ter o valor de &ldquo;ignored&rdquo; ou &ldquo;approved&rdquo;;</li><li>se o resultado for &ldquo;approved&rdquo;, também passaremos o campo &ldquo;resource_id&rdquo; com o identificador do resource ao qual o consentimento foi dado.</li></ul><p>Assim, fica fácil para a desenvolvedora prover uma experiência para ambos os casos: basta validar estes campos!</p><h4 id=fluxo-para-a-usuária>Fluxo para a usuária</h4><p>Para uma integração <a href=https://docs.openbank.stone.com.br/docs/modelos-de-parceria-guides#section-open-banking>Open Banking</a> de sucesso é essencial considerar a experiência da usuária, principalmente em fluxos de redirecionamento como para o consentimento. No início desta sessão detalhamos o passo a passo desse procedimento; neste tópico vamos exemplificar algumas das principais telas utilizadas.</p><p>Ao seguir o link gerado pela desenvolvedora, a usuária será redirecionada para uma página da Stone. Solicitaremos à dona o acesso à sua conta, explicitando quais permissões ela está concedendo à aplicação parceira. Podemos observar abaixo um exemplo de tela em que isso ocorre.</p><figure><img src=https://files.readme.io/e6c6443-consent-1.png alt="Tela de Consentimento.png"></figure><p>Caso a usuária opte por conceder o acesso no botão <code>Permitir</code> e ocorra tudo bem, será exibida uma tela de sucesso, confirmando que a permissão foi concedida. Podemos observar um exemplo dessa tela abaixo.</p><p>Ao clicar no botão <code>Ok, entendi</code> ela será redirecionada para uma página da aplicação parceira, cujo endereço foi definido no <a href=https://docs.openbank.stone.com.br/docs/cadastro-da-aplicacao-guides>cadastro da aplicação</a>, em Redirect URI.</p><figure><img src=https://files.readme.io/58f30d4-preview-chat-tl-consent-aprovado.png alt="Consentimento aprovado.png"></figure><p>É possível que ocorra também um caso em que a usuária já concedeu o acesso à aplicação parceira. Neste caso, a usuária irá visualizar uma tela como o seguinte exemplo.</p><p>Assim como no caso anterior, ela também será redirecionada para uma página da aplicação parceira ao clicar no botão <code>Ok, entendi</code>.</p><figure><img src=https://files.readme.io/00a5935-tl-com-consentimento.png alt="Consentimento já concedido.png"></figure></div><p class="post-meta border-bottom pb-3 mb-0 mt-3">Updated on 14 May 2020</p><nav class="pagination mt-3"><a class="nav nav-prev" href=https://stone-co.github.io/guias/integracao/testando-a-api/><i class="ti-arrow-left mr-2"></i><span class="d-none d-md-block">Testando a API</span></a>
<a class="nav nav-next" href=https://stone-co.github.io/guias/integracao/aprovacao/><span class="d-none d-md-block">Aprovação</span><i class="ti-arrow-right ml-2"></i></a></nav></div></div></div></div></section><footer class="section pb-4"><div class=container><div class="row align-items-center"><div class="col-md-8 text-md-left text-center"><p class="mb-md-0 mb-4"></p></div><div class="col-md-4 text-md-right text-center"><ul class=list-inline><li class=list-inline-item><a class="text-color d-inline-block p-2" href=#><i class=ti-world></i></a></li><li class=list-inline-item><a class="text-color d-inline-block p-2" href=#><i class=ti-github></i></a></li></ul></div></div></div></footer><script src=https://stone-co.github.io/js/script.min.js></script></body></html>