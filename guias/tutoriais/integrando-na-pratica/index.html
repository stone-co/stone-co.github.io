<!doctype html><html lang=pt><head><meta charset=utf-8><title>Integrando na Prática</title><meta name=generator content="Hugo 0.69.0"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=stylesheet href=https://stone-co.github.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://stone-co.github.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://stone-co.github.io/plugins/highlight/hybrid.css><link rel=icon href=https://stone-co.github.io/images/favicon.png type=image/x-icon><link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700&display=swap" rel=stylesheet><style>:root{--primary-color:#14aa4b;--body-color:#f8f9fd;--text-color:#677481;--text-color-dark:#5a6872;--white-color:#ffffff;--light-color:#f4f4f9;--font-family:Montserrat}</style><link href=https://stone-co.github.io/css/style.min.css rel=stylesheet media=screen><script src=https://stone-co.github.io/plugins/jquery/jquery-1.12.4.js></script><script src=https://stone-co.github.io/plugins/jquery/jquery-ui.js></script><script src=https://stone-co.github.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://stone-co.github.io/plugins/match-height/jquery.matchHeight-min.js></script><script src=https://stone-co.github.io/plugins/highlight/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></head><body><header class="shadow-bottom sticky-top bg-white"><nav class="navbar navbar-expand-md navbar-light"><div class=container><a class="navbar-brand px-2" href=/><img class=img-fluid src=https://stone-co.github.io/stoneg.png alt="Stone OpenBank"></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation aria-controls=navigation aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class="nav-link text-dark" href=/></a></li><li class=nav-item><a class="nav-link text-dark" href=/referencia-da-api>Referência da API</a></li><li class=nav-item><a class="nav-link text-dark" href=/guias>Guias</a></li><li class=nav-item><a class="nav-link text-dark" href="https://app.pipefy.com/public/form/Qz4ptt_W?origem_do_lead=Formul%C3%A1rio%20comercial%20documenta%C3%A7%C3%A3o">Quero ser parceiro</a></li></ul></div></div></nav></header><section class="single section-sm pb-0"><div class=container><div class=row><div class=col-lg-3><div class="bg-white pl-lg-4 py-4 pr-4 mb-5 mb-lg-0 sticky-top top-100 overflow-hidden"><ul class=list-styled><a class="d-block h4 back-btn" href=/></a><li data-nav-id=https://stone-co.github.io/guias/ title=Guias class=sidelist><a href=https://stone-co.github.io/guias/>Guias</a><ul><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/ title="Stone Openbank API" class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/>Stone Openbank API</a><ul><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/overview/ title=Overview class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/overview/>Overview</a></li><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/quickstart/ title=Quickstart class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/quickstart/>Quickstart</a></li><li data-nav-id=https://stone-co.github.io/guias/stone-openbank-api/ambientes-da-api/ title="Ambientes da API" class=sidelist><a href=https://stone-co.github.io/guias/stone-openbank-api/ambientes-da-api/>Ambientes da API</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/ title="A Conta Stone" class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/>A Conta Stone</a><ul><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/overview/ title=Overview class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/overview/>Overview</a></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/modelos-de-parceria/ title="Modelos De Parceria" class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/modelos-de-parceria/>Modelos De Parceria</a></li><li data-nav-id=https://stone-co.github.io/guias/a-conta-stone/aplicativos/ title=Aplicativos class=sidelist><a href=https://stone-co.github.io/guias/a-conta-stone/aplicativos/>Aplicativos</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/integracao/ title=Integração class=sidelist><a href=https://stone-co.github.io/guias/integracao/>Integração</a><ul><li data-nav-id=https://stone-co.github.io/guias/integracao/boas-praticas/ title="Boas Práticas" class=sidelist><a href=https://stone-co.github.io/guias/integracao/boas-praticas/>Boas Práticas</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/cadastro-da-aplicacao/ title="Cadastro da Aplicação" class=sidelist><a href=https://stone-co.github.io/guias/integracao/cadastro-da-aplicacao/>Cadastro da Aplicação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/autenticacao/ title=Autenticação class=sidelist><a href=https://stone-co.github.io/guias/integracao/autenticacao/>Autenticação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/testando-a-api/ title="Testando a API" class=sidelist><a href=https://stone-co.github.io/guias/integracao/testando-a-api/>Testando a API</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/consentimento/ title=Consentimento class=sidelist><a href=https://stone-co.github.io/guias/integracao/consentimento/>Consentimento</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/aprovacao/ title=Aprovação class=sidelist><a href=https://stone-co.github.io/guias/integracao/aprovacao/>Aprovação</a></li><li data-nav-id=https://stone-co.github.io/guias/integracao/webhooks/ title=Webhooks class=sidelist><a href=https://stone-co.github.io/guias/integracao/webhooks/>Webhooks</a></li></ul></li><li data-nav-id=https://stone-co.github.io/guias/tutoriais/ title=Tutoriais class=sidelist><a href=https://stone-co.github.io/guias/tutoriais/>Tutoriais</a><ul><li data-nav-id=https://stone-co.github.io/guias/tutoriais/integrando-na-pratica/ title="Integrando na Prática" class="sidelist
active"><a href=https://stone-co.github.io/guias/tutoriais/integrando-na-pratica/>Integrando na Prática</a></li></ul></li></ul></li></ul></div></div><div class=col-lg-9><div class="p-lg-5 p-4 bg-white"><h2 class=mb-5>Integrando na Prática</h2><div class=content><p>Neste tutorial vamos ver como:</p><ul><li>Gerar o token de <a href=https://docs.openbank.stone.com.br/docs/autenticacao-guides>autenticação</a>;</li><li>Gerar o token e link de <a href=https://docs.openbank.stone.com.br/docs/consentimento-guides>consentimento</a>;</li><li>Operar em contas que já concederam acesso à aplicação parceira.</li></ul><p>Utilizaremos a linguagem Python na versão 3.7 para montar o token e a <a href=https://pyjwt.readthedocs.io/en/latest/>biblioteca PyJWT</a> para assiná-lo.</p><div class="notices info"><p><strong>Conheça suas ferramentas</strong><br>É importante ler a documentação das bibliotecas utilizadas. A biblioteca utilizada neste tutorial, PyJWT, tem uma dependência extra para alguns algoritmos específicos. É o caso do algoritmo que será utilizado, RS256, que tem dependência da biblioteca <code>cryptography</code>. Por conta disso, esta biblioteca também precisa ser instalada.</p></div><h4 id=1-conhecendo-os-dados>1. Conhecendo os dados</h4><p>Como resultado do <a href=https://docs.openbank.stone.com.br/docs/cadastro-da-aplicacao-guides>cadastro da sua aplicação</a>, você recebeu um ClientID. Além disso, nos forneceu uma chave pública e manteve em segredo uma chave privada. Agora vamos ver como utilizá-los na prática.</p><p>Para montar os tokens, tenha em mãos o seu <code>redirect_uri</code> cadastrado, o seu ClientID e sua chave privada.</p><h4 id=2-se-preparando-para-gerar-tokens>2. Se preparando para gerar tokens</h4><p>Aqui vamos importar as bibliotecas que vamos utilizar e definir algumas constantes.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> jwt
<span style=color:#f92672>import</span> time
<span style=color:#f92672>import</span> requests

MINUTE <span style=color:#f92672>=</span> <span style=color:#ae81ff>60</span>
HOUR <span style=color:#f92672>=</span> <span style=color:#ae81ff>3600</span>

CLIENT_ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;92b5f9aa-9552-45f4-86cb-c0331c9178a2&#34;</span>
REDIRECT_URI <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://myapplication.com/consent_callback&#34;</span>

ACCOUNTS_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://sandbox-accounts.openbank.stone.com.br&#34;</span>
API_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://sandbox-api.openbank.stone.com.br/api/v1&#34;</span>
</code></pre></div><p>Armazenamos a chave privada no arquivo <code>private.pem</code> e preparamos uma função para gerar o token. Essa função recebe um parâmetro com os claims e usa a chave privada para gerar e assinar o token.</p><p>Lembrando que se trata de um processo de criptografia assimétrica. Neste processo, a desenvolvedora assina o token com sua chave privada e a Stone utiliza a chave pública compartilhada com a gente para verificar que realmente foi a aplicação parceira quem gerou o token.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_token</span>(claims):
    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;private.pem&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> key_file:
        token <span style=color:#f92672>=</span> jwt<span style=color:#f92672>.</span>encode(claims, key_file<span style=color:#f92672>.</span>read(), algorithm<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;RS256&#39;</span>)
        <span style=color:#66d9ef>return</span> token<span style=color:#f92672>.</span>decode()
</code></pre></div><p>Agora podemos assinar qualquer conjunto de claims e o resultado será um JWT.
É possível utilizar claims arbitrários para testar essa funcionalidade:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>&gt;&gt;&gt;</span> generate_token({<span style=color:#e6db74>&#34;claim&#34;</span>: <span style=color:#e6db74>&#34;qualquer&#34;</span>})
<span style=color:#e6db74>&#39;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJjbGFpbSI6InF1YWxxdWVyIn0.hUGnpB5pI38TbQy8XDjXMmFTLWvYjk98UaTELfkJmHU0EK9-ZOTzSSNKdqOB0puGHr2xMRXta6WZLQmkRqJCVHSA6zsIdW0ABJiPaHXVOHFidq7iGZAbZtgHBf6b3ctko7OGxfLDJGedH3gYVh9i_tJ3S0kWpvLS7yMqNgwyHI4ZJecmL-qYD30FgrhGqyMK3LCxId7O_T6_QOisaLe_XXstXUnm82qvDh7iMZPqhV39V_CxnLl6CVZp2IfdQ3i8LAmtqaxhYSTODwBj47zOm_4bhfOcMO91LxY3wWW8fU7Qr8hyiUHqayBTiLRYqEGet_esQ_rrVFOn0F3tU0eWSA&#39;</span>
</code></pre></div><p>Se chegou a este mesmo resultado, você tem uma função que pode ser utilizada para assinar qualquer um dos seus tokens.</p><p>A biblioteca escolhida incluiu automaticamente no header as informações de tipo e algorítimo utilizados para gerar o token. Para se certificar da validade do token é possível utilizar o site <a href=https://jwt.io>jwt.io</a>.</p><p>Observe que trabalhamos com vários tokens JWT diferentes e utilizamos claims diferentes de acordo com a finalidade do token.</p><p>Para o token de autenticação, é preciso utilizar os claims descritos em <a href=doc:autenticacao-guides>Autenticação</a>; para o token de consentimento, serão utilizados os claims descritos em <a href=doc:consentimento-guides>Consentimento</a>.</p><h4 id=3-montando-o-token-de-autenticação>3. Montando o token de autenticação</h4><p>Inicialmente, é preciso consultar quais os claims específicos do token de autenticação na <a href=https://docs.openbank.stone.com.br/docs/autenticacao-guides#section-claims>documentação</a>.</p><p>Através da função que construimos é possível gerar e assinar esse token de forma simples.</p><p>Esse token será enviado para a Stone através de uma chamada para nosso servidor de autenticação, e enviaremos como resposta um <code>access_token</code>.</p><p>O <code>access_token</code> também é do tipo JWT, e funciona como uma chave de acesso para todas requisições na API.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>auth_claims</span>():
    now <span style=color:#f92672>=</span> int(time<span style=color:#f92672>.</span>time())
    <span style=color:#66d9ef>return</span> {
        <span style=color:#e6db74>&#34;aud&#34;</span>: f<span style=color:#e6db74>&#34;{ACCOUNTS_URL}/auth/realms/stone_bank&#34;</span>,
        <span style=color:#e6db74>&#34;clientId&#34;</span>: CLIENT_ID,
        <span style=color:#e6db74>&#34;exp&#34;</span>: now <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> MINUTE,
        <span style=color:#e6db74>&#34;iat&#34;</span>: now,
        <span style=color:#e6db74>&#34;jti&#34;</span>: f<span style=color:#e6db74>&#39;token_id:{str(time.time())}&#39;</span>,
        <span style=color:#e6db74>&#34;nbf&#34;</span>: now,
        <span style=color:#e6db74>&#34;realm&#34;</span>: <span style=color:#e6db74>&#34;stone_bank&#34;</span>,
        <span style=color:#e6db74>&#34;sub&#34;</span>: CLIENT_ID,
    }


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>authenticate</span>():
    auth_token <span style=color:#f92672>=</span> generate_token(auth_claims())
    data <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>&#34;client_assertion_type&#34;</span>: <span style=color:#e6db74>&#34;urn:ietf:params:oauth:client-assertion-type:jwt-bearer&#34;</span>,
        <span style=color:#e6db74>&#34;client_assertion&#34;</span>: auth_token,
        <span style=color:#e6db74>&#34;client_id&#34;</span>: CLIENT_ID,
        <span style=color:#e6db74>&#34;grant_type&#34;</span>: <span style=color:#e6db74>&#34;client_credentials&#34;</span>,
    }

    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
        f<span style=color:#e6db74>&#34;{ACCOUNTS_URL}/auth/realms/stone_bank/protocol/openid-connect/token&#34;</span>, data<span style=color:#f92672>=</span>data)

    <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#34;access_token&#34;</span>]
</code></pre></div><p>Neste exemplo, estamos definindo uma função que retorna um dicionário com todos os claims necessários para o token de autenticação. Em seguida, é preciso enviar esse token e mais algumas informações para o nosso serviço de autenticação via POST.</p><p>A biblioteca <code>requests</code> foi a escolhida para realizar as requisições HTTP. No parâmetro <code>data</code>, envia-se dados no formato &ldquo;x-www-form-urlencoded&rdquo; já que este é o formato esperado pelo servidor de autenticação. Ver <a href=https://2.python-requests.org/en/master/>documentação</a>.</p><p>No parâmetro <code>params</code> envia-se os dados no formato <a href=https://en.wikipedia.org/wiki/Query_string>Query String</a>, e no parâmetro <code>headers</code> informamos o que será enviado no cabeçalho da requisição.</p><p>Para facilitar o acesso aos dados da resposta, convertemos o conteúdo para JSON e retornamos o <code>access_token</code>.</p><p>Para utilizar o token de acesso, é preciso apenas adicionar esse token em um cabeçalho <code>authorization</code> com o valor <code>Bearer TOKEN</code>. Com isso, já é possível operar na API como é demonstrado mais a frente.</p><h4 id=4-montando-o-link-de-consentimento>4. Montando o link de consentimento</h4><p>Assim como para o token de autenticação, inicialmente consultamos quais os claims específicos do token de consentimento na <a href=https://docs.openbank.stone.com.br/docs/consentimento-guides#section-gerando-o-token>documentação</a> e, em seguida, utilizamos a função que construimos para gerar e assinar o token.</p><p>Neste caso, vamos um pouco além da geração do token, utilizando uma função para montar o link de consentimento com os três parâmetros especificados na <a href=https://docs.openbank.stone.com.br/docs/consentimento-guides#section-o-link-de-consentimento-deve-conter-tr-s-par-metros->documentação</a>.</p><p>Resumindo o passo a passo para obter o link do consentimento, é preciso:</p><ol><li>Montar os claims para o token;</li><li>Criar o token;</li><li>Montar o link.</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>consent_claims</span>():
    now <span style=color:#f92672>=</span> int(time<span style=color:#f92672>.</span>time())
    <span style=color:#66d9ef>return</span> {
        <span style=color:#e6db74>&#34;aud&#34;</span>: <span style=color:#e6db74>&#34;accounts-hubid@openbank.stone.com.br&#34;</span>,
        <span style=color:#e6db74>&#34;client_id&#34;</span>: CLIENT_ID,
        <span style=color:#e6db74>&#34;exp&#34;</span>: now <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> HOUR,
        <span style=color:#e6db74>&#34;iat&#34;</span>: now,
        <span style=color:#e6db74>&#34;iss&#34;</span>: CLIENT_ID,
        <span style=color:#e6db74>&#34;jti&#34;</span>: str(time<span style=color:#f92672>.</span>time()),
        <span style=color:#e6db74>&#34;nbf&#34;</span>: now,
        <span style=color:#e6db74>&#34;redirect_uri&#34;</span>: REDIRECT_URI,
        <span style=color:#e6db74>&#34;session_metadata&#34;</span>: {<span style=color:#e6db74>&#34;sid&#34;</span>: f<span style=color:#e6db74>&#39;key:{time.time()}&#39;</span>},
        <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;consent&#34;</span>,
    }
  
  
 <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>consent_token</span>():
    <span style=color:#66d9ef>return</span> generate_token(consent_claims())
  
 <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>consent_link</span>():
    <span style=color:#66d9ef>return</span> f<span style=color:#e6db74>&#34;{ACCOUNTS_URL}/#/consent?type=consent&amp;client_id={CLIENT_ID}&amp;jwt={consent_token()}&#34;</span>
</code></pre></div><p>O resultado será um link válido por duas horas. Ele pode ser acessado e testado através do navegador.</p><p>Observe que alguns detalhes podem ser adaptados de acordo com as necessidades específiicas de controle de tokens da sua aplicação.</p><p>Um exemplo é parâmetro <code>jti</code>, que faz parte dos claims e atua como um identificador do token. No código acima, é utilizada apenas uma string com o timestamp do momento como forma de garantir sua unicidade. Para sua aplicação é possível utilizar outros valores de forma a facilitar a identificação do token.</p><p>Outro exemplo é o campo <code>session_metadata</code>, para o qual passamos um dicionário único apenas por ser um campo obrigatório. Neste caso não temos intenção de controlar a sessão, mas a desenvolvedora pode utilizá-lo para esta finalidade, passando valores que se encaixam nas suas necessiades.</p><h4 id=5-utilizando-a-api>5. Utilizando a API</h4><p>Utilizando seu <code>access_token</code> já é possível acessar as funcionalidades da API, de acordo com o que a sua aplicação tem permissão de fazer. Para ter permissão de criar transações em contas de usuários, ou até de visualizar seus dados, é preciso obter consentimento do dono da conta. Isso é possível enviando o link construído no passo anterior para a usuária, para que ela possa dar acesso à conta.</p><h5 id=consultando-as-contas-às-quais-a-aplicação-parceira-tem-acesso>Consultando as contas às quais a aplicação parceira tem acesso</h5><p>Através da API é possível, por exemplo, consultar a quais contas você tem acesso, tanto no caso de você ser uma aplicação parceira com consentimento para acessar contas, quanto no caso de você ser proprietário de alguma conta.</p><p>Para isso, é preciso apenas consultar o endpoint <a href=https://docs.openbank.stone.com.br/reference#consultar-todas-contas-%C3%A0s-quais-a-usu%C3%A1ria-tem-acesso>Consultar Todas Contas às Quais Se Tem Acesso</a>, utilizando seu <code>access_token</code> no campo do botão <code>Try It</code>.</p><p>Outra forma de acessar esse endpoint é realizando uma chamada para nossa API, enviando seu <code>access_token</code> em um header. Abaixo podemos observar isso em um exemplo de função que poderia ser utilizada para realizar essa consulta.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>operational_accounts</span>(access_token, pagination_params<span style=color:#f92672>=</span>{}):
    url <span style=color:#f92672>=</span> f<span style=color:#e6db74>&#34;{API_URL}/accounts&#34;</span>
    params <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;paginate&#34;</span>: <span style=color:#e6db74>&#34;true&#34;</span>, <span style=color:#f92672>**</span>pagination_params}
    
    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(
        url,
        params<span style=color:#f92672>=</span>params,
        headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;authorization&#34;</span>: f<span style=color:#e6db74>&#39;Bearer {access_token}&#39;</span>}
    )<span style=color:#f92672>.</span>json()
    <span style=color:#66d9ef>return</span> response[<span style=color:#e6db74>&#39;data&#39;</span>]
</code></pre></div><p>Analisando o código acima, podemos chegar às seguintes conclusões:</p><p>Observe que temos dois parâmetros na função <code>operational_accounts</code>: <code>access_token</code> e <code>pagination_params</code>.</p><ul><li><p><code>access_token</code> : É o resultado de uma autenticação bem sucedida. Sempre que uma aplicação parceira se autenticar receberá um token de acesso, cuja validade é informada em seus claims;</p></li><li><p><code>pagination_params</code>: A maior parte dos nossos endpoints utilizam uma <a href=https://docs.openbank.stone.com.br/reference#pagina%C3%A7%C3%A3o>paginação padrão</a>. Isso permite realizar requisições HTTP de forma mais prática, além de poupar consumo de rede.</p></li></ul><p>E, por fim, obtem-se como resposta uma lista das contas às quais a aplicação tem acesso.</p><div class="notices tip"><p><strong>Padrões da Nossa API</strong><br>Seguimos alguns padrões para alguns tipos de dados em toda a nossa API. <a href=https://docs.openbank.stone.com.br/reference#data-e-hora>Aqui</a> se encontram alguns destes padrões.</p></div><h5 id=criando-transferências-em-uma-conta>Criando transferências em uma conta</h5><p>Outra funcionalidade é a criação de transferências, tanto entre contas Stone como também de uma conta Stone para contas em outros bancos.</p><p>Assim como no caso anterior e de forma padrão para nossos endpoints, para acessá-los é preciso apenas obter permissão de acesso através do consentimento ou ser a própria dona da conta, e provar isso enviando seu <code>access_token</code> em um header. As informações de permissões de um sujeito são armazenadas em seu <code>access_token</code>.</p><p>O exemplo a seguir foi construído considerando uma aplicação com acesso a pelo menos duas contas, e que a primeira conta tem saldo suficiente para a transferência.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>internal_transfer</span>(token, params):
    url <span style=color:#f92672>=</span> f<span style=color:#e6db74>&#39;{API_URL}/internal_transfers&#39;</span>

    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url,
                             json<span style=color:#f92672>=</span>params,
                             headers<span style=color:#f92672>=</span>{
                                 <span style=color:#e6db74>&#34;authorization&#34;</span>: f<span style=color:#e6db74>&#39;Bearer {token}&#39;</span>
                             })<span style=color:#f92672>.</span>json()

    <span style=color:#66d9ef>return</span> response
  
token <span style=color:#f92672>=</span> authenticate()
  
accounts <span style=color:#f92672>=</span> operational_accounts(token)
  
internal_transfer_params <span style=color:#f92672>=</span> {
    <span style=color:#e6db74>&#34;amount&#34;</span>: <span style=color:#ae81ff>1000</span>,
    <span style=color:#e6db74>&#34;account_id&#34;</span>: accounts[<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#34;id&#34;</span>],
    <span style=color:#e6db74>&#34;target&#34;</span>: {
        <span style=color:#e6db74>&#34;account&#34;</span>: {<span style=color:#e6db74>&#34;account_code&#34;</span>: accounts[<span style=color:#ae81ff>1</span>][<span style=color:#e6db74>&#34;account_code&#34;</span>]}
    }
}
  
response <span style=color:#f92672>=</span> internal_transfer(token, internal_transfer_params)
<span style=color:#66d9ef>print</span>(response<span style=color:#f92672>.</span>json())
</code></pre></div><p>Ocorrendo tudo bem, você receberá como retorno as informações da transferência recém-criada. Em caso de erro como, por exemplo, por saldo insuficiente, receberá como retorno uma mensagem de erro.</p><h6 id=sucesso>Sucesso</h6><pre><code class=language-json5 data-lang=json5>{
  &quot;amount&quot;: 1000,
  &quot;approval_expired_at&quot;: null,
  &quot;approved_at&quot;: null,
  &quot;approved_by&quot;: null,
  &quot;cancelled_at&quot;: null,
  &quot;created_at&quot;: &quot;2019-07-29T13:40:05Z&quot;,
  &quot;created_by&quot;: &quot;application:92b5f9aa-9552-45f4-86cb-c0331c9178a2&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;failed_at&quot;: null,
  &quot;failure_reason_code&quot;: null,
  &quot;failure_reason_description&quot;: null,
  &quot;fee&quot;: 0,
  &quot;finished_at&quot;: null,
  &quot;id&quot;: &quot;000ebdf8-4acf-4ed2-83e9-f0c7a766ac61&quot;,
  &quot;rejected_at&quot;: null,
  &quot;rejected_by&quot;: null,
  &quot;scheduled_to&quot;: null,
  &quot;settled_at&quot;: null,
  &quot;status&quot;: &quot;CREATED&quot;,
  &quot;target&quot;: {
    &quot;account&quot;: {
      &quot;account_code&quot;: &quot;517532&quot;
    },
    &quot;entity&quot;: {
      &quot;name&quot;: &quot;Severo&quot;
    }
  },
  &quot;target_account_code&quot;: &quot;517532&quot;,
  &quot;target_account_owner_name&quot;: &quot;Severo&quot;
}
</code></pre><h6 id=failure>Failure</h6><pre><code class=language-json5 data-lang=json5>{&quot;type&quot;: &quot;srn:error:not_enough_funds&quot;}
</code></pre><h4 id=conclusão>Conclusão</h4><p>Utilizando tokens é possível se autenticar e realizar a solicitação de consentimento em contas de usuárias de forma segura.</p><p>É preciso utilizar uma biblioteca para gerar e assinar os tokens JWT. A escolha da biblioteca deve ser feita com cuidado pois é preciso ter conhecimento de como utilizá-la corretamente para obter sucesso gerando os tokens.</p><p>É interessante também consultar os claims específicos para cada token na sessão adequada da documentação, além de se atentar à necessidade de utilizar sua chave privada e o algoritmo RS256 para assinar seus tokens.</p><p>Utilizando o <code>access_token</code> e obtendo consentimento, já é possível realizar chamadas na API e acessar suas funcionalidades, como consultar as contas às quais a aplicação tem acesso, consultar o saldo dessas contas e criar transferências.</p></div><p class="post-meta border-bottom pb-3 mb-0 mt-3">Updated on 14 May 2020</p><nav class="pagination mt-3"><a class="nav nav-prev" href=https://stone-co.github.io/guias/tutoriais/><i class="ti-arrow-left mr-2"></i><span class="d-none d-md-block">Tutoriais</span></a>
<a class="nav nav-next" href=https://stone-co.github.io/parceiros/><span class="d-none d-md-block">Parceiros</span><i class="ti-arrow-right ml-2"></i></a></nav></div></div></div></div></section><footer class="section pb-4"><div class=container><div class="row align-items-center"><div class="col-md-8 text-md-left text-center"><p class="mb-md-0 mb-4"></p></div><div class="col-md-4 text-md-right text-center"><ul class=list-inline><li class=list-inline-item><a class="text-color d-inline-block p-2" href=#><i class=ti-world></i></a></li><li class=list-inline-item><a class="text-color d-inline-block p-2" href=#><i class=ti-github></i></a></li></ul></div></div></div></footer><script src=https://stone-co.github.io/js/script.min.js></script></body></html>